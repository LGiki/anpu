---
import { getCollection } from 'astro:content'
import Button from '@/components/Button.astro'
import ConcertMetadata from '@/components/ConcertMetadata.astro'
import SongList from '@/components/SongList.astro'
import { defaultLang } from '@/i18n/ui'
import { getLangFromUrl, useTranslatedPath, useTranslations } from '@/i18n/utils'
import Layout from '@/layouts/Layout.astro'
import { slugify } from '@/utils'
import { Icon } from 'astro-icon/components'

export async function getStaticPaths() {
  const concerts = await getCollection('concert', (concert) => {
    const [concertLanguage] = concert.id.split('/')
    return concertLanguage !== defaultLang
  })

  return concerts.map((concert) => {
    const [concertLanguage, ...slugs] = concert.id.split('/')
    return {
      params: { slug: slugify(slugs.join()), lang: concertLanguage },
      props: { concert },
    }
  })
}

const { concert } = Astro.props

const urlLanguage = getLangFromUrl(Astro.url)
const t = useTranslations(urlLanguage)
const translatePath = useTranslatedPath(urlLanguage)
---

<Layout
  title={concert.data.title ? [concert.data.title, "Concert"] : "Concert"}
>
  <div class="flex flex-col gap-4">
    {
      concert.data.title && (
        <h1
          class="font-medium text-2xl text-[var(--foreground)]"
          title={concert.data.title}
        >
          ðŸŽ¤ {concert.data.title}
        </h1>
      )
    }
    <SongList songTitles={concert.data.list} />
    {
      (concert.data.tour ||
        concert.data.startTime ||
        concert.data.endTime ||
        concert.data.guests ||
        concert.data.place ||
        concert.data.location ||
        concert.data.date) && (
        <ConcertMetadata
          tour={concert.data.tour}
          startTime={concert.data.startTime}
          endTime={concert.data.endTime}
          guests={concert.data.guests}
          place={concert.data.place}
          location={concert.data.location}
          date={concert.data.date}
        />
      )
    }
  </div>
  {
    concert.data.talkingPageSlug && (
      <slot slot="header-right">
        <a href={translatePath(`/talking/${concert.data.talkingPageSlug}`)}>
          <Button>
            <Icon name="ph:chat-dots" class="w-4 h-4 mr-2" />
            {t("concert.goToTalkingPage")}
          </Button>
        </a>
      </slot>
    )
  }
</Layout>
